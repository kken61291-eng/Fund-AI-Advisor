name: Daily AI Fund Advisor (Analysis)

on:
  schedule:
    # [å…³é”®ä¿®æ”¹] æ”¹ä¸ºæ¯å°æ—¶ç¬¬ 15 åˆ†é’Ÿè¿è¡Œ
    # ç¡®ä¿åœ¨ Data Crawler (ç¬¬0åˆ†é’Ÿè¿è¡Œ) å®Œæˆæ•°æ®æ›´æ–°åæ‰§è¡Œ
    - cron: '15 * * * *'
  workflow_dispatch:

jobs:
  analyze_and_report:
    runs-on: ubuntu-latest
    env:
      # é…ç½®æ‚¨çš„ç¯å¢ƒå˜é‡ (GitHub Secrets)
      LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
      LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
      EMAIL_USER: ${{ secrets.EMAIL_USER }}
      EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
      EMAIL_TO: ${{ secrets.EMAIL_TO }}
      TZ: Asia/Shanghai

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        # [å…³é”®å¿½ç•¥ç‚¹ä¿®å¤] å¿…é¡»åœ¨è¿™é‡Œä¹Ÿå¼ºåˆ¶å‡çº§ akshare
        # å¦åˆ™ main.py é‡Œçš„ NewsAnalyst ä¼šå› ä¸ºç‰ˆæœ¬è¿‡æ—§æŠ“ä¸åˆ° 7x24 ç”µæŠ¥
        pip install --upgrade akshare

    - name: ğŸ“¥ Pull latest data
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        git pull origin main || echo "No new data to pull"

    - name: ğŸš€ Run AI Analysis (Main)
      run: |
        python main.py

    - name: ğŸ“ˆ Auto-update portfolio ledger
      run: |
        # å¦‚æœ main.py æ›´æ–°äº† ledger.csv (äº¤æ˜“è®°å½•)ï¼Œéœ€è¦æäº¤ä¿å­˜
        if [[ -n $(git status --porcelain data_user/ledger.csv) ]]; then
          git add data_user/ledger.csv
          git commit -m "ğŸ“ˆ Auto-update portfolio ledger [skip ci]"
          git push
        else
          echo "No trade changes."
        fi
